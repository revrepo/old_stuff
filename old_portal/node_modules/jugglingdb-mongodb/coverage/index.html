<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="bootstrap.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="navbar">
            <div class="navbar-inner">
                <div class="container">
                    <span class="brand"> Test Coverage</span>
                    <ul class="nav">
                        <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="#lib">./lib (74%)</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="span6" style="margin-top: 10px;">
                        <div class="progress progress-warning"> <div class="bar" style="width: 74%"><strong>74%</strong> [103/139]</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="group-header row" id="lib"><div class="group-name span5">./lib</div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 74%"><strong>74%</strong> [103/139]</div></div></div></div><div id="lib-mongodb-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-mongodb-js" class="filename trigger" name="lib-mongodb-js">lib/mongodb.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 74%"><strong>74%</strong> [103/139]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> mongodb = <span class="func">require</span>(<span class="S">'mongodb'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> ObjectID = mongodb.ObjectID;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.initialize = <span class="kwrd">function</span> <span class="func">initializeSchema</span>(schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!mongodb) <span class="kwrd">return</span>;</code><span class="hits">6</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> s = schema.settings;</code><span class="hits">6</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (schema.settings.rs) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        s.rs = schema.settings.rs;</code></li><li class=""><code>        <span class="kwrd">if</span> (schema.settings.url) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> uris = schema.settings.url.<span class="func">split</span>(<span class="S">','</span>);</code></li><li class=""><code>            s.hosts = <span class="gly">[</span><span class="gly">]</span></code></li><li class=""><code>            s.ports = <span class="gly">[</span><span class="gly">]</span></code></li><li class=""><code>            uris.<span class="func">forEach</span>(<span class="kwrd">function</span>(uri) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> url = <span class="func">require</span>(<span class="S">'url'</span>).<span class="func">parse</span>(uri);</code></li><li class=""><code></code></li><li class="uncovered"><code>                s.hosts.<span class="func">push</span>(url.hostname <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>);</code></li><li class="uncovered"><code>                s.ports.<span class="func">push</span>(<span class="func">parseInt</span>(url.port <span class="gly">|</span><span class="gly">|</span> <span class="S">'27017'</span>, 10));</code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (!s.database) s.database = url.pathname.<span class="func">replace</span>(/^\<span class="C">//, '');</span></code></li><li class="uncovered"><code>                <span class="kwrd">if</span> (!s.username) s.username = url.auth &amp;&amp; url.auth.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code></li><li class="uncovered"><code>                <span class="kwrd">if</span> (!s.password) s.password = url.auth &amp;&amp; url.auth.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        s.database = s.database <span class="gly">|</span><span class="gly">|</span> <span class="S">'test'</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (schema.settings.url) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> url = <span class="func">require</span>(<span class="S">'url'</span>).<span class="func">parse</span>(schema.settings.url);</code><span class="hits">6</span></li><li class="covered"><code>            s.host = url.hostname;</code><span class="hits">6</span></li><li class="covered"><code>            s.port = url.port;</code><span class="hits">6</span></li><li class="covered"><code>            s.database = url.pathname.<span class="func">replace</span>(/^\<span class="C">//, '');</span></code><span class="hits">6</span></li><li class="covered"><code>            s.username = url.auth &amp;&amp; url.auth.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">6</span></li><li class="covered"><code>            s.password = url.auth &amp;&amp; url.auth.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>1<span class="gly">]</span>;</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        s.host = s.host <span class="gly">|</span><span class="gly">|</span> <span class="S">'localhost'</span>;</code><span class="hits">6</span></li><li class="covered"><code>        s.port = <span class="func">parseInt</span>(s.port <span class="gly">|</span><span class="gly">|</span> <span class="S">'27017'</span>, 10);</code><span class="hits">6</span></li><li class="covered"><code>        s.database = s.database <span class="gly">|</span><span class="gly">|</span> <span class="S">'test'</span>;</code><span class="hits">6</span></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    s.safe = s.safe <span class="gly">|</span><span class="gly">|</span> false;</code><span class="hits">6</span></li><li class=""><code></code></li><li class="covered"><code>    schema.adapter = <span class="kwrd">new</span> <span class="func">MongoDB</span>(s, schema, callback);</code><span class="hits">6</span></li><li class="covered"><code>    schema.ObjectID = ObjectID;</code><span class="hits">6</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> MongoObjectID = <span class="kwrd">function</span> <span class="func">ObjectID</span>(id) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id !== <span class="S">'string'</span>) <span class="kwrd">return</span> id;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">new</span> mongodb.<span class="func">ObjectID</span>(id);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">MongoDB</span>(s, schema, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> i, n;</code><span class="hits">6</span></li><li class="covered"><code>    this.name = <span class="S">'mongodb'</span>;</code><span class="hits">6</span></li><li class="covered"><code>    this._models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">6</span></li><li class="covered"><code>    this.collections = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">6</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> server;</code><span class="hits">6</span></li><li class=""><code>    <span class="kwrd">if</span> (s.rs) <span class="gly">{</span></code></li><li class="uncovered"><code>        set = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">for</span> (i = 0, n = s.hosts.length; i &lt; n; i++) <span class="gly">{</span></code></li><li class="uncovered"><code>            set.<span class="func">push</span>(<span class="kwrd">new</span> mongodb.<span class="func">Server</span>(s.hosts<span class="gly">[</span>i<span class="gly">]</span>, s.ports<span class="gly">[</span>i<span class="gly">]</span>, <span class="gly">{</span>auto_reconnect: true<span class="gly">}</span>));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        server = <span class="kwrd">new</span> mongodb.<span class="func">ReplSetServers</span>(set, <span class="gly">{</span>rs_name: s.rs<span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        server = <span class="kwrd">new</span> mongodb.<span class="func">Server</span>(s.host, s.port, <span class="gly">{</span><span class="gly">}</span>);</code><span class="hits">6</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">new</span> mongodb.<span class="func">Db</span>(s.database, server, <span class="gly">{</span> safe: s.safe <span class="gly">}</span>).<span class="func">open</span>(<span class="kwrd">function</span> (err, client) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) throw err;</code><span class="hits">6</span></li><li class=""><code>        <span class="kwrd">if</span> (s.username &amp;&amp; s.password) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> t = this;</code><span class="hits">6</span></li><li class=""><code>            client.<span class="func">authenticate</span>(s.username, s.password, <span class="kwrd">function</span> (err, result) <span class="gly">{</span></code></li><li class="covered"><code>              t.client = client;</code><span class="hits">6</span></li><li class="covered"><code>              schema.client = client;</code><span class="hits">6</span></li><li class="covered"><code>              <span class="func">callback</span>();</code><span class="hits">6</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">6</span></li><li class=""><code></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            this.client = client;</code></li><li class="uncovered"><code>            schema.client = client;</code></li><li class="uncovered"><code>            <span class="func">callback</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this));</code><span class="hits">6</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.define = <span class="kwrd">function</span> (descr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">if</span> (!descr.settings) descr.settings = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">19</span></li><li class="covered"><code>    this._models<span class="gly">[</span>descr.model.modelName<span class="gly">]</span> = descr;</code><span class="hits">19</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.defineProperty = <span class="kwrd">function</span> (model, prop, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    this._models<span class="gly">[</span>model<span class="gly">]</span>.properties<span class="gly">[</span>prop<span class="gly">]</span> = params;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.defineForeignKey = <span class="kwrd">function</span> (model, key, cb) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">cb</span>(null, MongoObjectID);</code><span class="hits">10</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.collection = <span class="kwrd">function</span> (name) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.collections<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>        this.collections<span class="gly">[</span>name<span class="gly">]</span> = <span class="kwrd">new</span> mongodb.<span class="func">Collection</span>(this.client, name);</code><span class="hits">16</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> this.collections<span class="gly">[</span>name<span class="gly">]</span>;</code><span class="hits">172</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.create = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (data.id === null) <span class="gly">{</span></code></li><li class="uncovered"><code>        delete data.id;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">insert</span>(data, <span class="gly">{</span><span class="gly">}</span>, <span class="kwrd">function</span> (err, m) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, err ? null : m<span class="gly">[</span>0<span class="gly">]</span>._id);</code><span class="hits">81</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">81</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.save = <span class="kwrd">function</span> (model, data, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> id = data.id;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = <span class="kwrd">new</span> <span class="func">ObjectID</span>(id);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">update</span>(<span class="gly">{</span>_id: id<span class="gly">}</span>, data, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.exists = <span class="kwrd">function</span> (model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = <span class="kwrd">new</span> <span class="func">ObjectID</span>(id);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">findOne</span>(<span class="gly">{</span>_id: id<span class="gly">}</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, !!(!err &amp;&amp; data));</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.find = <span class="kwrd">function</span> <span class="func">find</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        id = <span class="kwrd">new</span> <span class="func">ObjectID</span>(id);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">findOne</span>(<span class="gly">{</span>_id: id<span class="gly">}</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (data) data.id = id;</code><span class="hits">11</span></li><li class="covered"><code>        <span class="func">callback</span>(err, data);</code><span class="hits">11</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">11</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.updateOrCreate = <span class="kwrd">function</span> <span class="func">updateOrCreate</span>(model, data, callback) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> adapter = this;</code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (!data.id) <span class="kwrd">return</span> this.<span class="func">create</span>(data, callback);</code></li><li class=""><code>    this.<span class="func">find</span>(model, data.id, <span class="kwrd">function</span> (err, inst) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>        <span class="kwrd">if</span> (inst) <span class="gly">{</span></code></li><li class="uncovered"><code>            adapter.<span class="func">updateAttributes</span>(model, data.id, data, callback);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            delete data.id;</code></li><li class=""><code>            adapter.<span class="func">create</span>(model, data, <span class="kwrd">function</span> (err, id) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code></li><li class=""><code>                <span class="kwrd">if</span> (id) <span class="gly">{</span></code></li><li class="uncovered"><code>                    data.id = id;</code></li><li class="uncovered"><code>                    delete data._id;</code></li><li class="uncovered"><code>                    <span class="func">callback</span>(null, data);</code></li><li class=""><code>                <span class="gly">}</span> else<span class="gly">{</span></code></li><li class=""><code>                    <span class="func">callback</span>(null, null); <span class="C">// wtf?</span></code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.destroy = <span class="kwrd">function</span> <span class="func">destroy</span>(model, id, callback) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = <span class="kwrd">new</span> <span class="func">ObjectID</span>(id);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    this.<span class="func">collection</span>(model).<span class="func">remove</span>(<span class="gly">{</span>_id: id<span class="gly">}</span>, callback);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.all = <span class="kwrd">function</span> <span class="func">all</span>(model, filter, callback) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> mongo = this;</code><span class="hits">39</span></li><li class=""><code>    <span class="kwrd">if</span> (!filter) <span class="gly">{</span></code></li><li class="covered"><code>        filter = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> query = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">39</span></li><li class=""><code>    <span class="kwrd">if</span> (filter.where) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (filter.where.id) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> id = filter.where.id;</code><span class="hits">5</span></li><li class="covered"><code>            delete filter.where.id;</code><span class="hits">5</span></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                id = <span class="kwrd">new</span> <span class="func">ObjectID</span>(id);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            filter.where._id = id;</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(filter.where).<span class="func">forEach</span>(<span class="kwrd">function</span> (k) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> cond = filter.where<span class="gly">[</span>k<span class="gly">]</span>;</code><span class="hits">27</span></li><li class="covered"><code>            <span class="kwrd">var</span> spec = false;</code><span class="hits">27</span></li><li class=""><code>            <span class="kwrd">if</span> (cond &amp;&amp; cond.constructor.name === <span class="S">'Object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                spec = Object.<span class="func">keys</span>(cond)<span class="gly">[</span>0<span class="gly">]</span>;</code><span class="hits">4</span></li><li class="covered"><code>                cond = cond<span class="gly">[</span>spec<span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (spec) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (spec === <span class="S">'between'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span> $gte: cond<span class="gly">[</span>0<span class="gly">]</span>, $lte: cond<span class="gly">[</span>1<span class="gly">]</span><span class="gly">}</span>;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="kwrd">if</span> (spec === <span class="S">'inq'</span>) <span class="gly">{</span></code></li><li class=""><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span> $<span class="kwrd">in</span>: cond.<span class="func">map</span>(<span class="kwrd">function</span>(x) <span class="gly">{</span></code></li><li class="covered"><code>                        <span class="kwrd">if</span> (<span class="S">'string'</span> !== <span class="kwrd">typeof</span> x) <span class="kwrd">return</span> x;</code><span class="hits">5</span></li><li class="covered"><code>                        <span class="kwrd">return</span> <span class="kwrd">new</span> <span class="func">ObjectID</span>(x);</code><span class="hits">5</span></li><li class="covered"><code>                    <span class="gly">}</span>)<span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span><span class="gly">[</span><span class="S">'&#36;'</span> + spec<span class="gly">]</span> = cond;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (cond === null) <span class="gly">{</span></code></li><li class="uncovered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = <span class="gly">{</span>$type: 10<span class="gly">}</span>;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                    query<span class="gly">[</span>k<span class="gly">]</span> = cond;</code><span class="hits">23</span></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">21</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> cursor = this.<span class="func">collection</span>(model).<span class="func">find</span>(query);</code><span class="hits">39</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.order) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> keys = filter.order;</code><span class="hits">8</span></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> keys === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            keys = keys.<span class="func">split</span>(<span class="S">','</span>);</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> args = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">8</span></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> index <span class="kwrd">in</span> keys) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> m = keys<span class="gly">[</span>index<span class="gly">]</span>.<span class="func">match</span>(/\s+(A<span class="gly">|</span>DE)SC$/);</code><span class="hits">8</span></li><li class="covered"><code>            <span class="kwrd">var</span> key = keys<span class="gly">[</span>index<span class="gly">]</span>;</code><span class="hits">8</span></li><li class="covered"><code>            key = key.<span class="func">replace</span>(/\s+(A<span class="gly">|</span>DE)SC$/, <span class="S">''</span>).<span class="func">trim</span>();</code><span class="hits">8</span></li><li class=""><code>            <span class="kwrd">if</span> (m &amp;&amp; m<span class="gly">[</span>1<span class="gly">]</span> === <span class="S">'DE'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                args<span class="gly">[</span>key<span class="gly">]</span> = -1;</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                args<span class="gly">[</span>key<span class="gly">]</span> = 1;</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        cursor.<span class="func">sort</span>(args);</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.limit) <span class="gly">{</span></code></li><li class="covered"><code>        cursor.<span class="func">limit</span>(filter.limit);</code><span class="hits">21</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filter.skip) <span class="gly">{</span></code></li><li class="covered"><code>        cursor.<span class="func">skip</span>(filter.skip);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (filter.offset) <span class="gly">{</span></code></li><li class="uncovered"><code>        cursor.<span class="func">skip</span>(filter.offset);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    cursor.<span class="func">toArray</span>(<span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (err) <span class="kwrd">return</span> <span class="func">callback</span>(err);</code><span class="hits">39</span></li><li class="covered"><code>        <span class="kwrd">var</span> objs = data.<span class="func">map</span>(<span class="kwrd">function</span> (o) <span class="gly">{</span> o.id = o._id; <span class="kwrd">return</span> o; <span class="gly">}</span>);</code><span class="hits">39</span></li><li class=""><code>        <span class="kwrd">if</span> (filter &amp;&amp; filter.include) <span class="gly">{</span></code></li><li class="covered"><code>            mongo._models<span class="gly">[</span>model<span class="gly">]</span>.model.<span class="func">include</span>(objs, filter.include, callback);</code><span class="hits">9</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">callback</span>(null, objs);</code><span class="hits">30</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">39</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.destroyAll = <span class="kwrd">function</span> <span class="func">destroyAll</span>(model, callback) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">collection</span>(model).<span class="func">remove</span>(<span class="gly">{</span><span class="gly">}</span>, callback);</code><span class="hits">26</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.count = <span class="kwrd">function</span> <span class="func">count</span>(model, callback, where) <span class="gly">{</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">count</span>(where, <span class="kwrd">function</span> (err, count) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">callback</span>(err, count);</code><span class="hits">2</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.updateAttributes = <span class="kwrd">function</span> <span class="func">updateAttrs</span>(model, id, data, cb) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> id === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        id = <span class="kwrd">new</span> <span class="func">ObjectID</span>(id);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    this.<span class="func">collection</span>(model).<span class="func">findAndModify</span>(<span class="gly">{</span>_id: id<span class="gly">}</span>, <span class="gly">[</span><span class="gly">[</span><span class="S">'_id'</span>,<span class="S">'asc'</span><span class="gly">]</span><span class="gly">]</span>, <span class="gly">{</span>$set: data<span class="gly">}</span>, <span class="gly">{</span><span class="gly">}</span>, <span class="kwrd">function</span>(err, object) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">cb</span>(err, object);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>MongoDB.<span class="kwrd">prototype</span>.disconnect = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.client.<span class="func">close</span>();</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
        </div>
    </body>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="bootstrap.js"></script>
    <script type="text/javascript" src="coverage.js"></script>
</html>

